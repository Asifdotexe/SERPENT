name: Pylint

on: [pull_request]

jobs:
  pylint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install

      - name: Run Pylint
        id: pylint
        continue-on-error: true
        run: |
          # Run pylint on source, app.py, and tests
          # Redirect output to file, also capture stderr
          poetry run pylint src/serpent app.py tests > pylint_report.txt 2>&1
          
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('pylint_report.txt', 'utf8');
              const MAX_LENGTH = 60000; // GitHub comment limit is ~65536
              let bodyContent = report;
              
              if (report.length > MAX_LENGTH) {
                bodyContent = report.substring(0, MAX_LENGTH) + "\n\n... (Output truncated due to length)";
              }
              
              if (!bodyContent.trim()) {
                  bodyContent = "No output captured from Pylint.";
              }

              const outcome = '${{ steps.pylint.outcome }}';
              const icon = outcome === 'success' ? '✅' : '⚠️';
              const summary = outcome === 'success' ? 'Pylint passed' : 'Pylint found issues';

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `### ${icon} ${summary}\n\n<details>\n<summary>View Pylint Report</summary>\n\n\`\`\`\n${bodyContent}\n\`\`\`\n</details>`
              });
              
              // If we want to fail the workflow if pylint failed:
              if (outcome === 'failure') {
                  core.setFailed('Pylint found issues.');
              }
            } catch (error) {
              core.setFailed(error.message);
            }
